// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                      String   @id @default(uuid())
  name                    String
  email                   String   @unique
  password_hash           String
  city                    String?
  photo_url               String?
  visibility_participation Boolean @default(true)
  organizer_rating        Float    @default(0)
  role                    String   @default("user") // "user" ou "organizer"
  
  // Relacionamentos
  created_events          Event[]  @relation("OrganizerEvents")
  registrations           Registration[]
  
  sent_friend_requests    Friendship[] @relation("Requester")
  received_friend_requests Friendship[] @relation("Recipient")
  sent_messages           Message[] @relation("Sender")
  received_messages       Message[] @relation("Recipient")
  
  reviews                 Review[]
  certificates            Certificate[]

  @@map("users")
}

model Event {
  id                  String   @id @default(uuid())
  organizer_id        String
  title               String
  description         String
  location_address    String?
  location_url        String?
  start_date          DateTime
  end_date            DateTime
  price               Float    @default(0)
  is_free             Boolean  @default(true)
  requires_approval   Boolean  @default(false)
  registration_open   DateTime?
  registration_close  DateTime?
  max_registrations   Int?
  allowed_checkins    Int      @default(1)
  status              String   @default("draft") // draft, published, ongoing, finished, canceled
  banner_url          String?
  workload_hours      Int?

  organizer           User     @relation("OrganizerEvents", fields: [organizer_id], references: [id])
  registrations       Registration[]
  reviews             Review[]
  certificates        Certificate[]

  @@map("events")
}

model Registration {
  id                    String   @id @default(uuid())
  event_id              String
  user_id               String
  status                String   @default("pending") // pending, approved, refused, waiting_payment, confirmed, cancelled
  registration_timestamp DateTime @default(now())
  payment_timestamp     DateTime?
  checkins_count        Int      @default(0)
  certificate_issued    Boolean  @default(false)

  event                 Event    @relation(fields: [event_id], references: [id])
  user                  User     @relation(fields: [user_id], references: [id])
  checkins              Checkin[]

  @@map("registrations")
}

model Checkin {
  id              String   @id @default(uuid())
  registration_id String
  timestamp       DateTime @default(now())
  method          String   // "manual" ou "qr"

  registration    Registration @relation(fields: [registration_id], references: [id])

  @@map("checkins")
}

model Friendship {
  id              String   @id @default(uuid())
  requester_id    String
  recipient_id    String
  status          String   @default("pending") // pending, accepted
  timestamp       DateTime @default(now())

  requester       User     @relation("Requester", fields: [requester_id], references: [id])
  recipient       User     @relation("Recipient", fields: [recipient_id], references: [id])

  @@map("friendships")
}

model Message {
  id              String   @id @default(uuid())
  sender_id       String
  recipient_id    String
  content         String
  attachment_url  String?
  timestamp       DateTime @default(now())

  sender          User     @relation("Sender", fields: [sender_id], references: [id])
  recipient       User     @relation("Recipient", fields: [recipient_id], references: [id])

  @@map("messages")
}

model Review {
  id          String   @id @default(uuid())
  event_id    String
  user_id     String
  rating      Int
  comment     String?
  timestamp   DateTime @default(now())

  event       Event    @relation(fields: [event_id], references: [id])
  user        User     @relation(fields: [user_id], references: [id])

  @@map("reviews")
}

model Certificate {
  id              String   @id @default(uuid())
  event_id        String
  user_id         String
  pdf_url         String
  issued_at       DateTime @default(now())
  validation_code String   @unique @default(uuid())

  event           Event    @relation(fields: [event_id], references: [id])
  user            User     @relation(fields: [user_id], references: [id])

  @@map("certificates")
}